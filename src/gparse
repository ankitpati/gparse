#!/usr/bin/env perl

use Mojolicious::Lite;

use File::Basename qw(dirname);
use lib dirname (__FILE__) . '/lib/perl5';

use GParse::Domain qw(all_as_hash);

sub clean_routes {
    my $extra = app->static->extra;
    delete $extra->{$_} foreach keys %$extra;
    return;
}

clean_routes;

get '/*url' => sub {
    my $c = shift;

    my $url = $c->stash ('url');

    # Stringify query, as it is not picked up in `$url` on unencoded `GET`s.
    my $query = q{} . $c->req->params;
    $url .= "?$query" if $query;

    my %response = all_as_hash $url;

    # Convert Perl truthy/falsy values to JS booleans. Refer to `Mojo::JSON`.
    foreach (keys %response) {
        $response{$_} //= '';
        $response{$_} = $response{$_} ? \1 : \0 if /^is_\w+/;
    }

    $c->render (json => \%response);
};

get '/' => 'gparse';

app->start;

__END__
